#!/bin/bash
echo ""
echo "==============================================================================="
echo "      ðŸš¨ THE ANVIO-DEV ENVIRONMENT ON THIS SYSTEM NEEDS YOUR ATTENTION ðŸš¨"
echo "==============================================================================="
echo "TL;DR: If you (1) run the following commands on your terminal one after"
echo "another, (2) close your terminal window after running all five commands, and"
echo "(3) re-activate anvio-dev in a new terminal, everything will continue working"
echo "and you will not need to read the rest of this message unless you are really"
echo "interested in understanding what is going on:"
echo ""
echo "    cd ~/github/anvio"
echo "    pip install -e . --force-reinstall --upgrade"
echo '    tempfile=$(mktemp)'
echo "    sed '/^export/d' \${CONDA_PREFIX}/etc/conda/activate.d/anvio.sh > \$tempfile"
echo '    mv "$tempfile" ${CONDA_PREFIX}/etc/conda/activate.d/anvio.sh'
echo ""
echo "OK. Here is a more complete version of what is happening here. First, we are very"
echo "sorry for the inconvenience.  We know that you don't have time for this kind of"
echo "stuff :/ And we are even more sorry because this is ONLY affecting anvi'o users"
echo "who are following the active development branch :("
echo ""
echo "This is happening because we had to modernize the anvi'o packaging system, which"
echo "has not been touched for almost 10 years, to catch up with the current Python best"
echo "practices. Previously, we kept anvi'o programs under \`bin/\` and \`sandbox/\`"
echo "directories in the codebase. That means, when you set up your anvi'o conda"
echo "environment to track the active codebase (i.e., \`anvio-dev\`), the conda activation"
echo "script had to set PATH variables in your shell pointing to these directories"
echo "so you could execute anvi'o programs directly from those directories in your"
echo "copy of the anvi'o code from GitHub. This strategy worked perfectly fine for"
echo "development, but it conflicted with modern Python packaging standards and created"
echo "issues when anvi'o needed to be installed in non-development environments or"
echo "distributed through standard Python packaging channels. As a result, we decided"
echo "that it was time to bite the bullet and have migrated all 160+ anvi'o programs"
echo "to use what we call 'entry points' -- a modern Python mechanism where programs"
echo "are installed as proper commands. Yes, we know, very fancy indeed ðŸ¥‚"
echo ""
echo "From now on setting up \`anvio-dev\` environments will use the pip command above,"
echo "rather than hacky means to modify PATH and PYTHONPATH variables. We have updated"
echo "our installation instructions to reflect that. And if you ran the pip command"
echo "above you should be golden: anvi'o programs should be running for you now, and"
echo "you will continue to get the latest anvi'o updates every time you activate your"
echo "conda environment, exactly as before. For the small fraction of users who are"
echo "also anvi'o developers, any changes you make to the anvi'o Python code will "
echo "continue to be immediately visible when you test your changes just like before"
echo "(but using the modern Python infrastructure)."
echo ""
echo "Here is just a bit more technical details: the old \`bin/\` and \`sandbox/\`"
echo "directories in the anvi'o codebase are no longer in affect. The new programs"
echo "are stored under \`anvio/cli\` directory. That said, the \`bin/\` directory is"
echo "still there, but in only contains empty anvi'o programs that simply print this"
echo "message. We did this so that you can't miss this message and can solve the"
echo "problem without having to reinstall \`anvio-dev\` from scratch ðŸ˜‡"
echo ""
echo "Overall, this is a one-time migration that brings anvi'o up to current Python"
echo "packaging standards."
echo ""
echo "If you would like to see updated installation instructions for anvio-dev, please"
echo "visit:"
echo ""
echo "    https://anvio.org/install/#development-version"
echo ""
echo "As always, anvi'o developers are thankful for your patience, and thanks for the"
echo "chat. We should do it again soon."
echo "==============================================================================="
