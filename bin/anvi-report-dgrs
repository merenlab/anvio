#!/usr/bin/env python
# -*- coding: utf-8
import sys
import argparse

import anvio
import anvio.dgrs as dgrs

from anvio.errors import ConfigError, FilesNPathsError
from anvio.terminal import time_program, Run

__author__ = "Developers of anvi'o (see AUTHORS.txt)"
__copyright__ = "Copyleft 2015-2024, the Meren Lab (http://merenlab.org/)"
__credits__ = []
__license__ = "GPL 3.0"
__version__ = anvio.__version__
__authors__ = ["katysloz"]
__requires__ = []
__provides__ = []
__description__ = "A program designed to find Diversity Generating Retroelements based on nucleotide similarity"

run = Run()

@time_program
def main(args):
    D = dgrs.DGR_Finder(args)
    blast_output = D.run_blastn()
    mismatch_hits = D.filter_blastn_for_none_identical(blast_output)
    DGRs_found_dict = D.filter_for_TR_VR(mismatch_hits)
    csv_file_path = D.create_found_tr_vr_csv(DGRs_found_dict)
    
#call function here for filtering hits of blast from root 
def float_range(mini,maxi):
    """Return function handle of an argument type function for 
       ArgumentParser checking a float range: mini <= arg <= maxi
         mini - minimum acceptable argument
         maxi - maximum acceptable argument"""

    # Define the function with default arguments
    def float_range_checker(arg):
        """New Type function for argparse - a float within predefined range."""

        try:
            f = float(arg)
        except ValueError:    
            raise argparse.ArgumentTypeError("must be a decimal number")
        if f < mini or f > maxi:
            raise argparse.ArgumentTypeError("must be in range [" + str(mini) + "-" + str(maxi)+"]")
        return f

    # Return function handle to checking function
    return float_range_checker

my_float_range= float_range(0.5,1.0)

if __name__ == '__main__':
    from anvio.argparse import ArgumentParser

    parser = ArgumentParser(description=__description__)
    groupA = parser.add_argument_group('INPUT DATA', "Essentially a sequence file and nothing more.")

    groupA.add_argument("-i", "--input-file", required=True, help=("Genome sequence file, with multiple or singular sequence/s, or really any fasta file with sequences."))
    
    groupB = parser.add_argument_group('BLASTN ARGUMENTS', "BLASTn parameters for initial Template and Variable Region search")
    groupB.add_argument("-s", "--step", help="Length of base pairs you would like to cut your genome/sequence into", type=int, default=100)
    groupB.add_argument("-ws","--word-size", help="BLASTn word size parameter", type=str, default=8)
    groupC = parser.add_argument_group('MISCELLANEOUS', "Other options for the fine tuning of this program")
    groupC.add_argument("--skip-Ns", help="Skip 'N' bases when searching for mismatches", action = 'store_true', default=True)
    groupC.add_argument("--skip-dashes", help="Skip '-' bases when searching for mismatches", action = 'store_true',default=True)
    groupD = parser.add_argument_group('FILTER BLAST FOR TR/VRS', "Parameters for refining how stringent your search for template and variable regions is")
    groupD.add_argument("-pm","--percentage_mismatch", help="The Percentage of mismatching bases that are one 'type' of base. Has to be between 0.5 and 1.00", type=my_float_range, default=0.8)
    groupD.add_argument("-nm","--number_of_mismatches", help="Number of one 'type' of base that is mismatching to the sequence", type=int, default=7)

    args = parser.get_args(parser)


    try:
        main(args)
    except ConfigError as e:
        print(e)
        sys.exit(-1)
    except FilesNPathsError as e:
        print(e)
        sys.exit(-1)
