<html>

<head>
    <title>Contigs DB Stats</title>
    <script type="text/javascript" src="lib/jquery/dist/jquery.min.js"></script>
    <script type='text/javascript' src='js/utils.js'></script>
    <link rel="stylesheet" href="lib/bootstrap/dist/css/bootstrap.min.css" />
    <script type="text/javascript" src="lib/bootstrap/dist/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="https://cdn.rawgit.com/arose/ngl/v0.10.4/dist/ngl.js"></script>
    <style type="text/css">
        body {
            background-color: black;
        }
    </style>

    <script type="text/javascript">
        var stage;

        window.addEventListener( "resize", function( event ){
            stage.handleResize();
        }, false );

/*        var SAAVs_array = [5, 43, 22, 30];
        var atomPair = [[ "22.CA", "5.CA" ], [ "22.CA", "43.CA" ],  [ "22.CA", "30.CA" ]];

        var SAAVs_string = SAAVs_array.join(", ");

        var schemeId = NGL.ColormakerRegistry.addScheme(function (params) {
          this.atomColor = function (atom) {
            if (atom.resno == SAAVs_array[0]) {
              return 0x0000FF  // blue
            } else if (atom.resno == SAAVs_array[1]) {
              return 0xFF0000  // red
            } else {
              return 0x00FF00  // green
            }
          }
        })*/

        function defaultStructureRepresentation( component ){
            // bail out if the component does not contain a structure
            if( component.type !== "structure" ) return;
            // add three representations
            component.addRepresentation( "cartoon", {
                aspectRatio: 3.0,
                scale: 1.5
            } );
            component.addRepresentation( "spacefill", {
                sele: "(" + SAAVs_string + ") and .CA",
                scale: 0.5,
                color: schemeId
            } );
            component.addRepresentation("distance", {
                atomPair: atomPair,
                color: "skyblue",
                labelUnit: "nm"
            } );

            // add annotation to a protein chain
            var chainText = {
            "A": "how do i put gene_caller_id here?",
            }
            var ap = component.structure.getAtomProxy()
            component.structure.eachChain(function (cp) {
                // annotation is anchored to the residue index equal to half the total number of residues
                ap.index = cp.atomOffset + Math.floor(cp.atomCount / 2)
                component.addAnnotation(ap.positionToVector3(), chainText[ cp.chainname ])
            }, new NGL.Selection("polymer"))

            stage.autoView();
        }

        function load_protein(gene_callers_id) {

            $.ajax({
                type: 'GET',
                cache: false,
                url: '/data/get_structure/' + gene_callers_id,
                success: function(data) {
                    // create tooltip element and add to document body
                    var tooltip = document.createElement("div")
                    Object.assign(tooltip.style, {
                        display: "none",
                        position: "fixed",
                        zIndex: 10,
                        pointerEvents: "none",
                        backgroundColor: "rgba( 0, 0, 0, 0.6 )",
                        color: "lightgrey",
                        padding: "8px",
                        fontFamily: "sans-serif"
                    })
                    document.body.appendChild(tooltip)

                    stage.removeAllComponents();

                    var stringBlob = new Blob( [ data['pdb_content'] ], { type: 'text/plain'} );
                    stage.loadFile(stringBlob, { ext: "pdb" }).then( defaultStructureRepresentation ).then();
                    // remove default hoverPick mouse action
                    stage.mouseControls.remove("hoverPick")
                    // listen to `hovered` signal to move tooltip around and change its text
                    stage.signals.hovered.add(function (pickingProxy) {
                        if (pickingProxy && (pickingProxy.atom || pickingProxy.bond)) {
                            var atom = pickingProxy.atom || pickingProxy.closestBondAtom
                            var mp = pickingProxy.mouse.position
                            tooltip.innerText = "SAAV: \n" + atom.qualifiedName() + "\nAla:\t19" + "\nIle:\t5"
                            tooltip.style.bottom = window.innerHeight - mp.y + 3 + "px"
                            tooltip.style.left = mp.x + 3 + "px"
                            tooltip.style.display = "block"
                        } else {
                        tooltip.style.display = "none"
                      }
                    })
                    
                }
            });
        }

        $( document ).ready(function() {
            stage = new NGL.Stage( "viewport" );

            $.ajax({
                type: 'GET',
                cache: false,
                url: '/data/get_available_structures?timestamp=' + new Date().getTime(),
                success: function(data) {
                    var available_structures = data['available_structures'];

                    available_structures.forEach(function(gene_callers_id) {
                        $('.available-structures').append('<a href="#" onclick="load_protein(' + gene_callers_id + ');">Gene callers id ' + gene_callers_id + '</a><br/>');
                    });

                    $('.available-structures>a:first').trigger('click');
                }
            });
        });
    </script>
</head>

<body>
    <div class="container-fluid parent-container">
        <div class="row">
            <div class="col-md-9">
                <div id="viewport" style="width:100%; height:100%;"></div>
            </div>
            <div class="col-md-3 available-structures">
            </div>
        </div>
    </div>
</body>

</html>
