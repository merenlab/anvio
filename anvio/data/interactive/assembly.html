<html>

<head>
    <title>assembly stats</title>
    <script type='text/javascript' src='lib/d3.js/d3.min.js'></script>
</head>

<body>
    <style>
    html,
    body {
        padding: 0px;
        margin: 0px;
        overflow: hidden;
    }

    .container {
        text-align: center;
    }


    .domain {
        fill: none;
        stroke-width: 1;
        stroke: black;
    }
    </style>
    <div class='container'>
    </div>
    <script>
    function getReadableSeqSizeString(seqSizeInBases, fixed) {
        // function based on answer at http://stackoverflow.com/questions/10420352/converting-file-size-in-bytes-to-human-readable
        var i = -1;
        var baseUnits = [' kB', ' MB', ' GB', ' TB'];
        do {
            seqSizeInBases = seqSizeInBases / 1000;
            i++;
        } while (seqSizeInBases >= 1000);
        fixed = fixed ? fixed : fixed == 0 ? 0 : 1;
        return Math.max(seqSizeInBases, 0.1).toFixed(fixed) + baseUnits[i];
    };

    function drawAssemblyPlot(stats, container, size) {
        var margin = 10;
        var svg = d3.select(container)
            .append('svg')
            .attr('width', size)
            .attr('height', size)
            .attr('viewBox', '0 0 ' + size + ' ' + size)
            .attr('style', 'display: inline-block;');
            //.attr('preserveAspectRatio', 'xMidYMid meet');

        var plot_radius = size / 2 - margin;

        var g = svg.append('g')
            .attr('transform', 'translate(' + size / 2 + ',' + size / 2 + ')');

        var angle = d3.scale.linear()
            .domain([0, 100])
            .range([0, 2 * Math.PI]);

        var radius = d3.scale.sqrt()
            .domain([stats.n_values[0].length, 0])
            .range([0, plot_radius]);

        var radius_reverse = d3.scale.sqrt()
            .domain([stats.n_values[0].length, 0])
            .range([plot_radius, 0]);

        var area = d3.svg.area.radial()
            .angle(function(d, i) { return angle(i); })
            .innerRadius(radius(0))
            .outerRadius(function(d) { return radius(d.length); });

        g.append('path')
            .datum(stats.n_values)
            .attr('fill', '#BBB')
            .attr('d', area);

        var n50arc = d3.svg.arc()
            .innerRadius(radius(stats.n_values[49].length))
            .outerRadius(plot_radius);

        var n90arc = d3.svg.arc()
            .innerRadius(radius(stats.n_values[89].length))
            .outerRadius(plot_radius);

        g.append('path')
            .attr('stroke-width', '0')
            .attr('fill', 'rgb(255, 127, 0)')
            .attr('d', n50arc({ startAngle: angle(0), endAngle: angle(50) }));

        g.append('path')
            .attr('stroke-width', '0')
            .attr('fill', 'rgb(253, 191, 111)')
            .attr('d', n90arc({ startAngle: angle(0), endAngle: angle(90) }));

        g.append('circle')
            .attr('fill', 'none')
            .attr('stroke-width', '3')
            .attr('stroke', '#555')
            .attr('cx', '0')
            .attr('cy', '0')
            .attr('r', plot_radius);

        var axis = d3.svg.axis()
            .orient("left")
            .tickValues([3,4,5,6,7,8,9,10,11,12].map(function(x){ return Math.pow(10, x); })) 
            .tickFormat(function(d) {
                g.append('circle')
                    .attr('fill', 'none')
                    .attr('stroke-width', '1')
                    .attr('stroke', '#666')
                    .attr('cx', '0')
                    .attr('cy', '0')
                    .attr('stroke-dasharray', '10, 10')
                    .attr('r', (radius(d) >= plot_radius / 2) ? radius(d) : 0);
                return getReadableSeqSizeString(d, 0);
            })
            .scale(radius_reverse);

        g.append("g")
            .attr('transform', 'translate(0,' + -1 * plot_radius + ')')
            .attr('font-family', 'Helvetica')
            .attr('font-size', '0.8em')
            .attr('fill', '#666')
            .call(axis)
            .selectAll("text")
            .attr("y", -6)
            .attr("x", -3);

        g.append('text')
            .attr('class', 'info')
            .attr('font-family', 'Helvetica')
            .attr('x', plot_radius)
            .attr('y', plot_radius);

        g.append('circle')
            .attr('fill', '#000000')
            .attr('fill-opacity', '0.0')
            .attr('cx', '0')
            .attr('cy', '0')
            .attr('r', '300')
            .on('mouseenter', function() {
                g.append('path')
                    .attr('class', 'hover')
                    .attr('fill', '#000000')
                    .attr('fill-opacity', '0.1')
                    .attr('pointer-events', 'none');

            })
            .on('mousemove', function() {
                var pos = d3.mouse(this);
                var radiant = Math.PI / 2 + Math.atan2(pos[1], pos[0]);
                if (radiant < 0)
                    radiant = 2 * Math.PI + radiant;

                var order = Math.floor(radiant / (2 * Math.PI) * 100);

                var arc = d3.svg.arc()
                    .innerRadius(0)
                    .outerRadius(plot_radius);

                g.select('.hover')
                    .attr('d', arc({ startAngle: angle(order), endAngle: angle(order + 1) }));

                g.selectAll('.info>tspan').remove();

                g.select('.info')
                    .append('tspan')
                    .attr('font-weight', 'bold')
                    .attr('dy', '1.4em')
                    .text("N" + (order + 1));

                g.select('.info')
                    .append('tspan')
                    .attr('dy', '1.4em')
                    .attr('x', plot_radius)
                    .text(stats.n_values[order].num_contigs + " contigs ");

                g.select('.info')
                    .append('tspan')
                    .attr('dy', '1.4em')
                    .attr('x', plot_radius)
                    .text(">= " + getReadableSeqSizeString(stats.n_values[order].length, 1));

            })
            .on('mouseleave', function() {
                g.select('.hover').remove();
                g.select('.info').selectAll('tspan').remove();
            });
    }

    function drawGenePlot(stats, container, width, height, margin) {
        var svg = d3.select(container)
            .append('svg')
            .attr('width', width)
            .attr('height', height)
            .attr('style', 'display: inline-block;');

        var g = svg.append("g")
            .attr("transform", "translate(" + margin + "," + margin + ")");

        var plot_width = width - 2 * margin;
        var plot_height = height - 2 * margin;

        var data = [];
        for (key in stats.single_copy_gene_counts['Campbell_et_al']) {
            data.push({'name': key, 'value': stats.single_copy_gene_counts['Campbell_et_al'][key]});
        }
        data.sort(function(a, b) { return (a['value'] < b['value']) - (a['value'] > b['value'])})

        var xscale = d3.scale.ordinal().rangeRoundBands([0, plot_width], .05); //.innerPadding(0.1);
        var yscale = d3.scale.linear().rangeRound([plot_height, 0]);
        var color_scale = d3.scale.linear().range(['#fff7bc', '#d95f0e']);

        xscale.domain(data.map(function(d) { return d.name; }));
        yscale.domain([0, d3.max(data, function(d) { return d.value; })]);
        color_scale.domain([0, d3.max(data, function(d) { return d.value; })]);

        var bar_group = g.selectAll(".bar")
                            .data(data)
                            .enter()
                            .append("g")
                            .on('mouseenter', function() {
                                d3.select(this).attr('fill-opacity', '0.5');
                            })
                            .on('mouseleave', function() {
                                d3.select(this).attr('fill-opacity', '1');
                            });

        bar_group.append('rect')
                .attr("class", "bar")
                .attr("x", function(d) { return xscale(d.name); })
                .attr("y", function(d) { return yscale(d.value); })
                .attr("width", xscale.rangeBand())
                .attr("fill", function(d) { return color_scale(d.value); })
                .attr("height", function(d) { return plot_height - yscale(d.value); });
        
/*        bar_group.append("text")
                .attr("x", function(d) { return xscale(d.name); })
                .attr("y", plot_height)
                .attr("fill", '#FFFFFF')
                .attr("text-anchor", "end")
                .attr("transform", 'translate()rotate(-90)')
                .text(function(d) { return d.name; });*/
    }

    d3.json("/data/get_assembly_stats", function(error, stats) {
        drawAssemblyPlot(stats, '.container', 600);
        drawGenePlot(stats, '.container', 600, 200, 10);
    });
    </script>
</body>

</html>