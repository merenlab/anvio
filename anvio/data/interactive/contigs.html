<html>

<head>
    <title>Contigs DB Stats</title>
    <script type="text/javascript" src="lib/jquery/dist/jquery.min.js"></script>
    <script type='text/javascript' src='js/utils.js'></script>
    <script type='text/javascript' src='lib/d3.js/d3.min.js'></script>
    <script type='text/javascript' src='js/contigs-plot.js'></script>
    <link rel="stylesheet" href="lib/bootstrap/dist/css/bootstrap.min.css" />
    <script type="text/javascript" src="lib/bootstrap/dist/js/bootstrap.min.js"></script>
    <link rel="stylesheet" type="text/css" href="css/contigs-plot.css" />
    <script type="text/javascript">
        var contigs_stats;
        var contig_db_names;
    </script>
</head>

<body>
    <div class="container-fluid parent-container">
        <div class="row row-centered row-menu" style="display: none; padding: 5px; margin-top: 10px;">
            <select id="select-left"></select> vs <select id="select-right"></select>
        </div>
        <div class="row row-centered row-plots">

        </div>

        <div class="container">
            <div style="text-align: right;">
                <input type="checkbox" id="checkbox_human_readable" name="checkbox_human_readable" checked='checked' onclick="create_table();">
                <label for="checkbox_human_readable">Human readable bases</label>
            </div>
            <table class="table table-details">
              <tbody>
              </tbody>
            </table>
        </div>
    </div>
    <script>
        function create_plots(index, prefix) {
            var contig_db_name = contig_db_names[index];
            var stats = contigs_stats[contig_db_name];

            var container = d3.select('.parent-container>.row-plots')
                                .append('div')
                                    .attr('class', 'col-sm-6')
                                    .append('div')
                                        .attr('class', 'round-corners-and-background')
                                        .attr('id', 'container' + prefix);

            // Add title

            container.append('div')
                .append('h3')
                .style('margin-top', '0px')
                .text(stats['project_name']);

            var plot_container = container.append('div')
                                            .attr('id', 'n_values_' + prefix);

            draw_n_values_plot('#n_values_' + prefix, stats);

            // Add single copy core gene plots

            var tabs = container.append('ul')
                                .attr('class', 'nav nav-tabs');

            var tab_content = container.append('div')
                                    .attr('class', 'tab-content');

            var max_hmm_hits = 0;
            var active_index = 0;
            Object.keys(stats.gene_hit_counts_per_hmm_source).forEach(function(source, gene_chart_index) {
                var plot_container_id = 'gene_chart_' + prefix + '_' + gene_chart_index;

                var hits_sum = 0;

                Object.keys(stats.gene_hit_counts_per_hmm_source[source]).forEach(function (gene) {
                    hits_sum += stats.gene_hit_counts_per_hmm_source[source][gene];
                });

                if (hits_sum > max_hmm_hits) {
                    max_hmm_hits = hits_sum;
                    active_index = gene_chart_index;
                }

                tabs.append('li')
                        .append('a')
                            .attr('href', '#' + plot_container_id)
                            .attr('data-toggle', 'tab')
                            .text(source.replace(/_/g, ' '));


                var plot_container = tab_content.append('div')
                                        .attr('class', 'tab-pane')
                                        .attr('role', 'tabpanel')
                                        .attr('id', plot_container_id);

                draw_gene_counts_chart('#' + plot_container_id, stats.gene_hit_counts_per_hmm_source[source]);
            });

            $('a[href="#gene_chart_' + prefix + '_' + active_index + '"').tab('show');
        }

        function create_table_header(header_text) {
            var columns = tables['header'];
            var table_str = '<tr class="info"><th>' + header_text + '</th>';

            columns.forEach(function(column) {
                table_str += '<th class="text-center">' + column + '</th>';
            });

            table_str += '</tr>';

            return table_str;
        }

        function array_to_table(table_array, placeholder_text, human_readable) {
            var human_readable_keys = ['L50', 'L75', 'L90', 'Shortest Contig', 'Longest Contig', 'Total Length'];

            var table_str = "";
            table_array.forEach(function(table_line) {
                table_str += '<tr>';
                var use_human_readable_for_this_line = human_readable;

                if (human_readable_keys.indexOf(table_line[0]) == -1) {
                    use_human_readable_for_this_line = false;
                }

                table_line.forEach(function(table_item, i) { 
                    var td_class = (i > 0) ? 'text-center' : '';

                    if (use_human_readable_for_this_line && i > 0) {
                        table_str += '<td class="' + td_class + '">' + getReadableSeqSizeString(parseInt(table_item)) + '</td>';
                    } else {
                        table_str += '<td class="' + td_class + '">' + table_item + '</td>';
                    }
                });

                table_str += '</tr>';
            });

            if (table_array.length == 0) {
                table_str = '<tr><td>' + placeholder_text + '</td></tr>';
            }

            return table_str;
        }

        function create_table() {
            var human_readable = $('#checkbox_human_readable').is(':checked');
            var table_str = "";
            table_str += create_table_header('Contigs Stats');
            table_str += array_to_table(tables['basic_stats'], 'No Basic Stats Found', human_readable);
            table_str += create_table_header('Raw number of HMM Hits');
            table_str += array_to_table(tables['hmm'], '<i>HMMs were not run</i>', human_readable);
            table_str += create_table_header('Approx. number of genomes <a href="http://merenlab.org/2015/12/07/predicting-number-of-genomes/">[?]</a>');
            table_str += array_to_table(tables['scg'], '<i>SCG HMMs were not run</i>', human_readable);

            $('.table-details>tbody').empty().append(table_str);
        }

        $('#select-left,#select-right').change(function() {
            $('.parent-container>.row-plots').empty();
            create_plots(parseInt($('#select-left').val()), 'left');
            create_plots(parseInt($('#select-right').val()), 'right'); 
        });

        d3.json("/data/get_contigs_stats", function(error, response) {
            contigs_stats = response['stats'];
            contig_db_names = Object.keys(contigs_stats);

            tables = response['tables']

            contig_db_names.forEach(function(name) {
                contigs_stats[name]['project_name'] = contigs_stats[name]['project_name'].replace(/_/g, ' ');
            });

            if (contig_db_names.length == 1) {
                d3.select('.parent-container>.row-plots')
                    .append('div')
                    .attr('class', 'col-sm-3');

                create_plots(0, 'left');
            } else if (contig_db_names.length == 2) {
                create_plots(0, 'left');
                create_plots(1, 'rights');
            } else {
                $('.row-menu').show();

                contig_db_names.forEach(function(name, index) {
                    var option = '<option value="' + index + '">' + contigs_stats[name]['project_name'] +  '</option>';
                    $('#select-left').append(option);
                    $('#select-right').append(option);

                    $('#select-left option:nth-child(1)').attr("selected", "selected");
                    $('#select-right option:nth-child(2)').attr("selected", "selected");

                    $('#select-left').trigger('change');
                });
            }

            create_table();
        });
    </script>
</body>

</html>
